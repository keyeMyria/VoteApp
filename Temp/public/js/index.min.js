var vm = new Vue({
    el:'html',
    data:{
        page:'index',
        loading:true,
        logs:0,
        query:'',
        list:[],
        // 已经投的id
        voteId:localStorage.getItem('voteId')
        
    },
    methods:{
        // 获取电影
        getMovie:function () {
            var that = this;
            $.get('/api/getMovie',function (res) {
                var data = JSON.parse(res);
                console.log(data);
                that.list = data.list;
                that.loading = false;
            });
        },
        searchOn:function(){
            $('.ui-searchbar-wrap').addClass('focus');
            $('.ui-searchbar-input input').focus();
        },
        searchOff:function(){
            $('.ui-searchbar-wrap').removeClass('focus');
        },
        slidePic:function(){
            var slider = new fz.Scroll('.ui-slider', {
                role: 'slider',
                indicator: true,
                autoplay: true,
                interval: 3000
            });
            slider.on('beforeScrollStart', function(from, to) {
                console.log(from, to);
            });
            slider.on('scrollEnd', function(curPage) {
                console.log(curPage);
            });
            console.log('ready');
        },
        // 简介
        desc:function (index) {
            var that = this;
            //自定义标题风格
            layer.open({
                title: [
                    '电影简介',
                    'background-color: #18B4ED; color:#fff;'
                ],
                content: that.list[index].des,
                btn: '我了解了'
            });  
        },
        // 投票
        doVote:function(index,cineId){
            // alert(cineId);
            var that = this;
            if(that.voteId > 0){
                // 代表已经投过票了
                layer.open({
                    content: '一个小时以内只能投给一个电影',
                    btn: '我知道了'
                });
                return;
            }else{
                var params = {
                    cineId : cineId
                };

                that.voteId = cineId;
                layer.open({
                    type: 2,
                    content: '加载中'
                });

                $.post('/api/doVote',params,function(result){
                    
                    
                    // layer.open({content:"等会再投，灿灿连接数没调整!",btn:"嗯",yes:function(ele){
                    //     layer.closeAll();
                    // }});
                    // return false;
                    
                    var res = JSON.parse(result);
                    
                    console.log(res);
                    if(res.state > 0){
                        // 投票成功
                        localStorage.setItem('voteId',cineId);
                        localStorage.setItem('voteTime',new Date().getTime());
                        layer.closeAll();
                        layer.open({content:'投票成功',time:3});
                        that.list[index].ticket = that.list[index].ticket + 1;
                        
                        // that.list[index].ticket = res.state;
                        return false;
                    }else if(res.state == -1){
                        // 1小时内不能重复投票
                        that.voteId = '-1';
                        layer.closeAll();
                        layer.open({
                            content: '一小时内只能投票一次',
                            btn: '我知道了'
                        });
                        return false;
                    }else if(res.state == -2){
                        that.voteId = '-1';
                        layer.closeAll();
                        layer.open({content:'网络故障，投票失败',time:3});
                        return false;
                    }
                });
                
            }
        },
        getNums:function () {
            var that = this;
            $.get('/api/getNum',function (res) {
                var data = JSON.parse(res);
                console.log(data);
                if(data.status == 1){
                    that.logs = data.number;
                }
                
            });
        }
        
    },
    computed:{
        
    },
    ready:function(){
        
        
        var that = this;
        
        // 用来看是否1小时以内
        var currentTime = new Date().getTime();
        var voteTime = localStorage.getItem('voteTime');
        console.log('currentTime'+currentTime);
        console.log('voteTime'+voteTime);
        console.log(currentTime - voteTime >= 3600000);
        if(currentTime - voteTime >= 3600000){
            localStorage.setItem('voteId','-1');
        }
        that.slidePic();
        that.getMovie();
        that.getNums();
        
        setTimeout(function () {
            if(that.loading === true){
                layer.open({content:'网络延迟，请重新加载'});    
            }
        },8000);
        
    }
});


